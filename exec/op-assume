#!/usr/bin/env bash

function main {
  local shome="$(cd -P -- "${BASH_SOURCE%/*}/.." && pwd -P)"
  source "$shome/script/profile"

  local nm_account="$1"; shift

  local pth_session="${BOARD_PATH}/.op/session-${nm_account}.gpg"

  local attempts=1
  while true; do
    if [[ ! -f "$pth_session" ]]; then
      gpg2 -q -d "${BOARD_PATH}/.op/${nm_account}.gpg" | op signin "${nm_account}" --output=raw | gpg2 -e -a -r "$(cat ~/.config/gpg-recipient 2>/dev/null || gpg2 --card-status 2>&1 | grep 'General key info' | awk '{print $NF}' | cut -d'<' -f2 | cut -d'>' -f1)" > "$pth_session"
    fi

    export "OP_SESSION_${nm_account}"="$(gpg2 -q -d "$pth_session")"

    if op get vault "meh-$$" 2>&1 | grep "Vault meh-$$ not found" >/dev/null 2>&1; then
      break
    fi

    rm -f "${pth_session}"
    attempts="$((attempts + 1))"
    if [[ "$attempts" -gt 2 ]]; then
      echo "ERROR: unable to get a valid 1Password session" 1>&2
      exit 2
    fi
  done
  
  if [[ "$#" == 0 ]]; then
    exec "$SHELL"
  else
    exec "$@"
  fi
}

source sub "$BASH_SOURCE" "$@"
